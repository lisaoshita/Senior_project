---
title: "Feature Engineering"
author: "Lisa Oshita"
date: "1/28/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# load data 
dir <- file.path(getwd(),"data")
age_gender <- read.csv(file.path(dir, "age_gender_bkts.csv"))
countries <- read.csv(file.path(dir, "countries.csv"))
sessions <- read.csv(file.path(dir, "sessionsSample.csv"))
sessions <- sessions[, -1] # removing extra X column 
train_users <- read.csv(file.path(dir, "train_users_2.csv"))
```

```{r}
# converting all factors to character
age_gender <- dplyr::mutate_if(age_gender, is.factor, as.character)
countries <- dplyr::mutate_if(countries, is.factor, as.character)
sessions <- dplyr::mutate_if(sessions, is.factor, as.character)
train_users <- dplyr::mutate_if(train_users, is.factor, as.character)
```

#### Train_users 

```{r}
# ===========================================================================
# date account created 
# ===========================================================================
train_users$acct_created_date <- as.Date(train_users$date_account_created, format="%Y-%m-%d")

# pulling apart month + year of date created 
train_users$acct_created_y <- format(train_users$acct_created_date, "%Y")
train_users$acct_created_m <- format(train_users$acct_created_date, "%m")

# day of the week
train_users$acct_created_wkd <- weekdays(train_users$acct_created_date)

# season
train_users$acct_created_sn[as.numeric(train_users$acct_created_m) >= 3 & 
                              as.numeric(train_users$acct_created_m) <= 6] <- "spring"
train_users$acct_created_sn[as.numeric(train_users$acct_created_m) >= 7 & 
                              as.numeric(train_users$acct_created_m) <= 9] <- "summer"
train_users$acct_created_sn[as.numeric(train_users$acct_created_m) >= 10 & 
                              as.numeric(train_users$acct_created_m) <= 11] <- "fall"
train_users$acct_created_sn[as.numeric(train_users$acct_created_m) == 12 |  
                              as.numeric(train_users$acct_created_m) <= 2] <- "winter"
```

```{r}
# ===========================================================================
# timestamp first active 
# ===========================================================================
# first active year 
train_users$firstactive_y <- stringr::str_sub(train_users$timestamp_first_active, start = 1, end = 4)

# first active month 
train_users$firstactive_m <- stringr::str_sub(train_users$timestamp_first_active, start = 5, end = 6)

# first active day 
train_users$firstactive_d <- stringr::str_sub(train_users$timestamp_first_active, start = 7, end = 8)

# first active full date 
train_users$firstactive_date <- as.Date(paste(train_users$firstactive_y, "-", 
                                              train_users$firstactive_m, "-", 
                                              train_users$firstactive_d, sep = ""), 
                                        format = "%Y-%m-%d")

# first active weekday 
train_users$firstactive_wkd <- weekdays(train_users$firstactive_date)
```

```{r}
# ===========================================================================
# date first booking
# ===========================================================================
train_users$firstbook_date <- as.Date(train_users$date_first_booking, format="%Y-%m-%d")

# pulling apart month + year 
train_users$firstbook_y <- format(train_users$firstbook_date, "%Y")
train_users$firstbook_m <- format(train_users$firstbook_date, "%m")

# day of the week
train_users$firstbook_wkd <- weekdays(train_users$firstbook_date)

# season 
train_users$firstbook_sn[as.numeric(train_users$firstbook_m) >= 3 & 
                              as.numeric(train_users$firstbook_m) <= 6] <- "spring"
train_users$firstbook_sn[as.numeric(train_users$firstbook_m) >= 7 & 
                              as.numeric(train_users$firstbook_m) <= 9] <- "summer"
train_users$firstbook_sn[as.numeric(train_users$firstbook_m) >= 10 & 
                              as.numeric(train_users$firstbook_m) <= 11] <- "fall"
train_users$firstbook_sn[as.numeric(train_users$firstbook_m) == 12 |  
                              as.numeric(train_users$firstbook_m) <= 2] <- "winter"

# indicator variable for if a user booked a trip
train_users$book <- 1
train_users$book[is.na(train_users$firstbook_date)] <- 0
```

```{r}
# ===========================================================================
# age 
# ===========================================================================
# age cleaned 

# leave users with age 15 - 110 as is 

# for users with ages in the 1900s, ageClean = year account created - age 
train_users$age_clean <- train_users$age
ages <- which(train_users$age > 1000 & train_users$age < 2000)
for (i in ages) {
  train_users$age_clean[i] <- as.numeric(train_users$acct_created_y[i]) - train_users$age[i] 
}

# how to deal with ages > 110 and > 15 and missing values?
# setting all users with ages > 2000 or < 15 as -1
train_users$age_clean[train_users$age < 15 | train_users$age > 110 ] <- -1

# ===========================================================================
# age ranges 

# 22 different age ranges: (15 - 20), (20 - 25), (25 - 30)... 
train_users$age_range <- cut(train_users$age_clean, 
                             breaks = c(min(train_users$age_clean, na.rm = TRUE), 
                                        seq(5, 110, by = 5)))
```

```{r}
# ===========================================================================
# gender (female, male, other, missing)
# ===========================================================================
# replacing -unknown- with OTHER
train_users$gender_clean <- stringr::str_replace(train_users$gender, 
                                           pattern = "-unknown-", 
                                           replacement = "OTHER")
```

#### Countries 

```{r}
# ===========================================================================
# merge countries df with train_users 
# ===========================================================================
x <- train_users %>% 
    dplyr::full_join(countries, by = "country_destination")
```

#### Sessions 

```{r}
sessionsSum <- sessions %>% 
  group_by(user_id) %>% 
  summarise(vars = table(action))

tally(sessions)

df <- sessions[sessions$user_id == "d1mm9tcy42", ] %>% 
  count(action)



```



```{r}
# ===========================================================================
# one hot encoding (do this last? - once have all vars set up)
# ===========================================================================
library(caret) # for dummyVars funct

# signup_method 
train_users <- cbind(train_users, # combine train_users with data frame of encoded variables 
                     data.frame(predict(dummyVars(" ~ signup_method", data = train_users), 
                                        newdata = train_users)))

# signup_flow
# 17 different levels - condense? 

# language 
train_users <- cbind(train_users, # combine train_users with data frame of encoded variables 
                     data.frame(predict(dummyVars(" ~ language", data = train_users), 
                                        newdata = train_users)))
# ===========================================================================
# function to encode var
encode <- function(var) {
  train_users <- cbind(train_users,
                       data.frame(predict(dummyVars(paste(" ~ ", var, sep = ""), data = train_users), 
                                          newdata = train_users)))
  return(train_users)
}
vars <- colnames(train_users)[10:15] # variables to encode
for(v in vars) { # iterate over each variable, encode, bind to train_users
  train_users <- encode(v)
}
```

